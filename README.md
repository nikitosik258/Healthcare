# Healthcare Billing

Проект по предсказанию суммы счёта за лечение пациента в стационаре.

## Постановка задачи
**Цель:** по данным о пациенте и госпитализации предсказать итоговый `Billing Amount`  
(регрессия, y ∈ ℝ, единицы — условные денежные единицы/рубли).

## Признаки
  - `Name` - Имя пациента
  - `Age` - Возраст пациента на момент госпитализации (в годах)
  - `Gender` - Пол пациента (Male — мужчина, Female — женщина)
  - `Blood Type` - Группа крови пациента (например, A+, O−, B+, AB−).
  - `Hospital` - Название больницы/клиники, где проходила госпитализация.
  - `Medical Condition` - Основной диагноз/медицинское состояние (например, Diabetes, Hypertension, Asthma).
  - `Insurance Provider` - Страховая компания пациента (Aetna, Blue Cross, Cigna, UnitedHealthcare, Medicare и др.).
  - `Room number` - Номер палаты, в которой размещён пациент.
  - `Admission Type` - Тип госпитализации (Emergency — экстренная, Elective — плановая, Urgent — срочная).
  - `Medication` - Назначенный пациенту препарат (Aspirin, Ibuprofen, Penicillin, Paracetamol, Lipitor и др.).
  - `Test Results` - Результат медицинского теста (Normal — норма, Abnormal — отклонение, Inconclusive — неоднозначный). 
  - `Date of Admission` - Дата поступления пациента в медицинское учреждение.
  - `Discharge Date` - Дата выписки пациента из медицинского учреждения.
- **Таргет:** `Billing Amount` - Сумма, выставленная к оплате за лечение

Даты преобразованы в тип `datetime`, из них выделены год/месяц/день недели, исходные поля `Date of Admission` и `Discharge Date` удалены.

## EDA (главные выводы)

- **Возраст** распределён относительно равномерно от ~20 до ~80 лет, без экстремальных выбросов.
- **Категориальные поля** умеренно несбалансированы: преобладают 1–2 значения в `Medical Condition`,
  `Insurance Provider`, `Admission Type`, но редких категорий немного.
- **Таргет `Billing Amount`**:
  - сильно скошен вправо, есть длинный «хвост» больших счетов;
  - несколько крупных значений, но без явных артефактов — оставлены как валидные наблюдения.
- Зависимость суммы счёта в основном связана с **возрастом** и **календарными признаками госпитализации**;
  вклад отдельных категориальных признаков (страховка, тип госпитализации) заметен, но слабее.
- Удаляем Hospital (тк он имеет 39876 уникальных значений, что очень много), номер комнаты, имя и доктора, тк они не несут какого-то значения.

## Baseline

- **CV:** `KFold(n_splits=5, shuffle=True, random_state=SEED)`  
- **Метрики:**  
  - основная — **MAE** (средняя абсолютная ошибка, в «деньгах»),  
  - дополнительные — **RMSE**, **R²**.
- **Модели и результаты (порядок величин):**

<img width="1264" height="450" alt="image" src="https://github.com/user-attachments/assets/47dec968-8e97-4810-b521-ec5fdbb8c4bc" />


- **Вывод:** из простых моделей лучше всего себя ведёт **RandomForestRegressor** — он даёт
  небольшое, но стабильное улучшение MAE/RMSE и положительный R².

- **Важности признаков (деревья / ансамбли):**
  - топ-факторы: `Age`, `Admission_Month`, `Admission_DayOfWeek`, `Blood Type`;
  - далее: `Admission_Year`, `Insurance Provider`, `Medical Condition`, `Admission Type`;
  - `Gender` даёт наименьший вклад.

## Improvements

- **Добавление нового признака:**
  - Добавил новый признак Length_of_stay - длина пребывания в больнице (в днях)
  - Новый признак дал небольшие улучшения

- **Препроцессинг:**
  - Базово использован `OrdinalEncoder` с фиксированным порядком категорий
  - Числовые признаки (`Age`, календарные поля) передаются без изменений
    (масштабирование/стандартизация мало влияет на деревья и лес).

- **Логарифмирование таргета:**
  - Рассматривалась модель по `log1p(Billing Amount)` для борьбы со скошенным распределением.
  - Качество всегда **оценивается в исходных единицах** (обратное преобразование `expm1`),
    чтобы не «накручивать» метрики.
  - Преобразование даёт небольшое улучшение устойчивости моделей к крупным счетам, но не меняет картину принципиально.

- **Работа с выбросами:**
  - Проверены простые варианты winsorization (обрезка хвостов по квантилям).
  - Серьёзного выигрыша по метрикам не дали, поэтому итоговая версия использует **сырые значения таргета**.

- **Биннинг признаков:**
  - Тестировались варианты бининга возраста.
  - Наблюдалось небольшое улучшение метрик.

## Гиперпараметры

### RandomForestRegressor

- **Поиск:**  
  - `GridSearchCV` / `RandomizedSearchCV` / `BayesSearchCV`  
  - `cv = KFold(5, shuffle=True, random_state=SEED)`  
  - `scoring='neg_mean_absolute_error'`.
 
**Лучше всего себя показал BayesSearchCV**

- **Диапазоны:**
  - `n_estimators: [100, 600]`
  - `max_depth: [3, 20]`
  - `min_samples_split: [2, 10]`
  - `min_samples_leaf: [1, 10]`
  - `max_features: ["sqrt", "log2", 0.5, 1.0]]`
  - `bootstrap: [True, False]`

- **Лучшие настройки (типовой пример):**
 - 'RandomForestRegressor__bootstrap': False,
 - 'RandomForestRegressor__max_depth': 20,
 - 'RandomForestRegressor__max_features': 'sqrt',
 - 'RandomForestRegressor__min_samples_leaf': 1,
 - 'RandomForestRegressor__min_samples_split': 2,
 - 'RandomForestRegressor__n_estimators': 600`

- **Прирост:**  
  - дало небольшое улучшения всех метрик.
 
## Итоговые метрики:
<img width="690" height="71" alt="image" src="https://github.com/user-attachments/assets/47eb96a8-197a-41dd-b8e7-e4ca520741bd" />


## Итог

- **RandomForestRegressor** после подбора гиперпараметров даёт
  наилучший компромисс между качеством и стабильностью, MAE ~11.5–12k.
- Проект показывает полный цикл:
  - EDA и анализ распределений,
  - базовые модели и выбор метрик,
  - настройка препроцессинга,
  - сравнение алгоритмов,
  - подбор гиперпараметров и анализ важности признаков.
